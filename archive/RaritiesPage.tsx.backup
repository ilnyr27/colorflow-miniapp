import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useGameStore } from '@/store/gameStore';
import { useTelegram } from '@/hooks/useTelegram';
import { GAME_CONFIG, PROGRESSION_TIMELINE, RARITY_COLORS, ACHIEVEMENT_TITLES, ACHIEVEMENT_DESCRIPTIONS } from '@/config/game';
import { Trophy, User, Globe, Star, Lock, CheckCircle, Clock, Target } from 'lucide-react';
import { ColorRarity } from '@/types/game';

type RaritiesTab = 'personal' | 'global' | 'achievements';

export const RaritiesPage: React.FC = () => {
  const [activeTab, setActiveTab] = useState<RaritiesTab>('personal');
  const { gallery, highestRarityAchieved, startDate } = useGameStore();
  const { colorScheme, hapticFeedback } = useTelegram();

  const tabs = [
    {
      id: 'personal' as RaritiesTab,
      label: 'Моя коллекция',
      icon: User,
      color: '#6c5ce7'
    },
    {
      id: 'global' as RaritiesTab,
      label: 'Общая статистика',
      icon: Globe,
      color: '#00b894'
    },
    {
      id: 'achievements' as RaritiesTab,
      label: 'Достижения',
      icon: Trophy,
      color: '#fdcb6e'
    }
  ];

  const handleTabChange = (tabId: RaritiesTab) => {
    setActiveTab(tabId);
    hapticFeedback.light();
  };

  // Подсчитываем дни игры
  const daysPlaying = Math.floor((Date.now() - startDate.getTime()) / (1000 * 60 * 60 * 24));

  // Группируем цвета по редкости
  const colorsByRarity = gallery.reduce((acc, color) => {
    if (!acc[color.rarity]) acc[color.rarity] = [];
    acc[color.rarity].push(color);
    return acc;
  }, {} as Record<ColorRarity, typeof gallery>);

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.05
      }
    }
  };

  const itemVariants = {
    hidden: { y: 20, opacity: 0 },
    visible: {
      y: 0,
      opacity: 1,
      transition: { duration: 0.5 }
    }
  };

  const getRarityStatus = (rarity: ColorRarity) => {
    const rarityIndex = GAME_CONFIG.RARITY_LEVELS.indexOf(rarity);
    const highestIndex = GAME_CONFIG.RARITY_LEVELS.indexOf(highestRarityAchieved);
    const requiredDays = PROGRESSION_TIMELINE[rarity];
    
    if (rarityIndex <= highestIndex) return 'achieved';
    if (daysPlaying >= requiredDays) return 'available';
    return 'locked';
  };

  // Глобальная статистика (мок данные)
  const globalStats = {
    totalPlayers: 15847,
    totalColors: 2847392,
    dailyActive: 3421,
    topCollectors: [
      { name: 'ColorMaster', colors: 1247, rarity: 'ultimate' },
      { name: 'PaletteKing', colors: 1156, rarity: 'ultimate' },
      { name: 'ChromaLord', colors: 987, rarity: 'ulterior' }
    ]
  };

  return (
    <div className={`rarities-page theme-${colorScheme}`}>
      {/* Header */}
      <motion.header 
        className="page-header"
        initial={{ y: -20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ duration: 0.5 }}
      >
        <div className="header-content">
          <h1 className="page-title">
            <Trophy size={24} />
            Редкости
          </h1>
        </div>
      </motion.header>

      {/* Tab Navigation */}
      <motion.div
        className="tab-navigation"
        initial={{ y: -10, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.1, duration: 0.5 }}
      >
        <div className="tab-container">
          {tabs.map((tab) => {
            const IconComponent = tab.icon;
            const isActive = activeTab === tab.id;
            
            return (
              <motion.button
                key={tab.id}
                className={`tab-button ${isActive ? 'active' : ''}`}
                onClick={() => handleTabChange(tab.id)}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                style={{
                  borderColor: isActive ? tab.color : 'transparent',
                  backgroundColor: isActive ? `${tab.color}20` : 'transparent'
                }}
              >
                <motion.div
                  className="tab-content"
                  animate={{
                    color: isActive ? tab.color : '#6c757d'
                  }}
                  transition={{ duration: 0.2 }}
                >
                  <IconComponent size={18} />
                  <span>{tab.label}</span>
                  
                  {isActive && (
                    <motion.div
                      className="tab-indicator"
                      layoutId="rarities-tab-indicator"
                      style={{ backgroundColor: tab.color }}
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      transition={{ duration: 0.3 }}
                    />
                  )}
                </motion.div>
              </motion.button>
            );
          })}
        </div>
      </motion.div>

      {/* Tab Content */}
      <motion.div
        className="rarities-content"
        variants={containerVariants}
        initial="hidden"
        animate="visible"
      >
        <AnimatePresence mode="wait">
          {activeTab === 'personal' && (
            <motion.div
              key="personal"
              className="tab-content-panel"
              variants={itemVariants}
              initial="hidden"
              animate="visible"
              exit="hidden"
            >
              <div className="content-section">
                <h3 className="section-title">
                  <User size={20} />
                  Моя коллекция
                </h3>
                <p className="section-description">
                  Ваши цвета по редкостям и прогресс стейкинга.
                </p>
                
                <div className="rarities-list">
                  {GAME_CONFIG.RARITY_LEVELS.map((rarity) => {
                    const status = getRarityStatus(rarity);
                    const ownedCount = colorsByRarity[rarity]?.length || 0;
                    const stakingTime = GAME_CONFIG.STAKING_TIME_TABLE[rarity]?.[0] || 0;
                    const upgradeReq = GAME_CONFIG.UPGRADE_REQUIREMENTS[rarity];
                    
                    return (
                      <motion.div
                        key={rarity}
                        className={`rarity-card ${status}`}
                        variants={itemVariants}
                        style={{ borderColor: RARITY_COLORS[rarity] }}
                      >
                        <div className="rarity-header">
                          <div className="rarity-info">
                            <div 
                              className="rarity-badge"
                              style={{ backgroundColor: RARITY_COLORS[rarity] }}
                            >
                              {status === 'achieved' && <CheckCircle size={16} />}
                              {status === 'locked' && <Lock size={16} />}
                              {status === 'available' && <Star size={16} />}
                            </div>
                            <div className="rarity-details">
                              <h4 className="rarity-name" style={{ color: RARITY_COLORS[rarity] }}>
                                {rarity.charAt(0).toUpperCase() + rarity.slice(1)}
                              </h4>
                              <p className="rarity-count">Цветов: {ownedCount}</p>
                            </div>
                          </div>
                          <div className="rarity-stats">
                            <div className="stat-item">
                              <Clock size={14} />
                              <span>{stakingTime}ч стейкинг</span>
                            </div>
                            <div className="stat-item">
                              <Target size={14} />
                              <span>{upgradeReq} для улучшения</span>
                            </div>
                          </div>
                        </div>
                      </motion.div>
                    );
                  })}
                </div>
              </div>
            </motion.div>
          )}

          {activeTab === 'global' && (
            <motion.div
              key="global"
              className="tab-content-panel"
              variants={itemVariants}
              initial="hidden"
              animate="visible"
              exit="hidden"
            >
              <div className="content-section">
                <h3 className="section-title">
                  <Globe size={20} />
                  Общая статистика
                </h3>
                <p className="section-description">
                  Масштабы ColorFlow и топ коллекционеры.
                </p>
                
                <div className="global-stats-grid">
                  <motion.div className="stat-card" variants={itemVariants}>
                    <div className="stat-value">{globalStats.totalPlayers.toLocaleString()}</div>
                    <div className="stat-label">Всего игроков</div>
                  </motion.div>
                  
                  <motion.div className="stat-card" variants={itemVariants}>
                    <div className="stat-value">{globalStats.totalColors.toLocaleString()}</div>
                    <div className="stat-label">Создано цветов</div>
                  </motion.div>
                  
                  <motion.div className="stat-card" variants={itemVariants}>
                    <div className="stat-value">{globalStats.dailyActive.toLocaleString()}</div>
                    <div className="stat-label">Активных сегодня</div>
                  </motion.div>
                </div>

                <div className="top-collectors">
                  <h4>🏆 Топ коллекционеры</h4>
                  {globalStats.topCollectors.map((collector, index) => (
                    <motion.div
                      key={collector.name}
                      className="collector-item"
                      variants={itemVariants}
                    >
                      <div className="collector-rank">#{index + 1}</div>
                      <div className="collector-info">
                        <div className="collector-name">{collector.name}</div>
                        <div className="collector-stats">
                          {collector.colors} цветов • {collector.rarity}
                        </div>
                      </div>
                      <div 
                        className="collector-badge"
                        style={{ backgroundColor: RARITY_COLORS[collector.rarity as ColorRarity] }}
                      />
                    </motion.div>
                  ))}
                </div>
              </div>
            </motion.div>
          )}

          {activeTab === 'achievements' && (
            <motion.div
              key="achievements"
              className="tab-content-panel"
              variants={itemVariants}
              initial="hidden"
              animate="visible"
              exit="hidden"
            >
              <div className="content-section">
                <h3 className="section-title">
                  <Trophy size={20} />
                  Достижения
                </h3>
                <p className="section-description">
                  Эпичные титулы и награды за коллекционирование.
                </p>
                
                <div className="achievements-list">
                  {GAME_CONFIG.RARITY_LEVELS.slice(1).map((rarity) => {
                    const isAchieved = getRarityStatus(rarity) === 'achieved';
                    const title = (ACHIEVEMENT_TITLES as any)[rarity] || rarity.charAt(0).toUpperCase() + rarity.slice(1);
                    const description = (ACHIEVEMENT_DESCRIPTIONS as any)[rarity] || `Достигните редкости ${rarity}`;
                    
                    return (
                      <motion.div
                        key={rarity}
                        className={`achievement-card ${isAchieved ? 'achieved' : 'locked'}`}
                        variants={itemVariants}
                        style={{ borderColor: RARITY_COLORS[rarity] }}
                      >
                        <div className="achievement-icon">
                          <div 
                            className="achievement-badge"
                            style={{ backgroundColor: RARITY_COLORS[rarity] }}
                          >
                            {isAchieved ? <Trophy size={20} /> : <Lock size={20} />}
                          </div>
                        </div>
                        
                        <div className="achievement-content">
                          <h4 className="achievement-title" style={{ color: RARITY_COLORS[rarity] }}>
                            {title}
                          </h4>
                          <p className="achievement-description">{description}</p>
                          <div className="achievement-rarity">
                            Редкость: {rarity.charAt(0).toUpperCase() + rarity.slice(1)}
                          </div>
                        </div>
                        
                        {isAchieved && (
                          <div className="achievement-status">
                            <CheckCircle size={24} style={{ color: RARITY_COLORS[rarity] }} />
                          </div>
                        )}
                      </motion.div>
                    );
                  })}
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>
    </div>
  );
};
